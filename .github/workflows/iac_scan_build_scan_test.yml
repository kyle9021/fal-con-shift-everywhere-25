name: FCS IAC Security Scan and Build Test using Docker Secrets
on: [push, pull_request]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Create secret files
        run: |
          echo "${{ secrets.CROWDSTRIKE_CLIENT_ID }}" > /tmp/client_id
          echo "${{ secrets.CROWDSTRIKE_CLIENT_SECRET }}" > /tmp/client_secret
          echo "${{ secrets.CROWDSTRIKE_API_URL }}" > /tmp/api_url
        
      - name: Build Docker image with secrets
        run: |
          docker build \
            --secret id=client_id,src=/tmp/client_id \
            --secret id=client_secret,src=/tmp/client_secret \
            --secret id=api_url,src=/tmp/api_url \
            --platform linux/amd64 \
            -t fcs-scanner .
            
      - name: Clean up secret files
        if: always()
        run: |
          rm -f /tmp/client_id /tmp/client_secret /tmp/api_url
        
      - name: Run Security Scan
        run: |
          docker run --rm \
            --platform linux/amd64 \
            -v "$(pwd):/workspace" \
            -e EXIT_WITH_FCS_CODE=true \
            -e SHOW_FULL_RESULTS=true \
            fcs-scanner
        
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('fcs-scan-results.sarif') != ''
        with:
          sarif_file: fcs-scan-results.sarif
        continue-on-error: true
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            fcs-scan-results.json
            fcs-scan-results.sarif
            fcs-scan-summary.txt
            
      - name: Display Results Summary
        if: always() && hashFiles('fcs-scan-summary.txt') != ''
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 fcs-scan-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
