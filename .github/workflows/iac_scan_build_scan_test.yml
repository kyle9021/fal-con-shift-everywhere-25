name: FCS IAC Security Scan and Build Test using Docker Secrets
on: [push, pull_request]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Create secret files
        run: |
          echo "${{ secrets.FALCON_CLIENT_ID }}" > /tmp/client_id
          echo "${{ secrets.FALCON_SECRET_ID }}" > /tmp/client_secret
          echo "${{ secrets.FALCON_API_URL }}" > /tmp/api_url
        
      - name: Build Docker image with secrets
        run: |
          docker build \
            --secret id=client_id,src=/tmp/client_id \
            --secret id=client_secret,src=/tmp/client_secret \
            --secret id=api_url,src=/tmp/api_url \
            --platform linux/amd64 \
            -t fcs-scanner .
            
      - name: Clean up secret files
        if: always()
        run: |
          rm -f /tmp/client_id /tmp/client_secret /tmp/api_url

      - name: Scan Container Image
        uses: crowdstrike/fcs-action@v2.0.1
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: 'us-1'
          scan_type: image
          image: fcs-scanner:latest
          output_path: './image-scan-results/'
          report_formats: json
        env:
          FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}
        
      - name: Run Security Scan
        run: |
          docker run --rm \
            --platform linux/amd64 \
            -v "$(pwd):/workspace" \
            -e EXIT_WITH_FCS_CODE=true \
            -e SHOW_FULL_RESULTS=true \
            fcs-scanner
        
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('fcs-scan-results.sarif') != ''
        with:
          sarif_file: fcs-scan-results.sarif
        continue-on-error: true
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            fcs-scan-results.json
            fcs-scan-results.sarif
            fcs-scan-summary.txt
            
      - name: Display Results Summary
        if: always() && hashFiles('fcs-scan-summary.txt') != ''
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 fcs-scan-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
